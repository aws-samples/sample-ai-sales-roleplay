---
name: devils-advocate-code-review
description: デビルズアドボケイト（悪魔の代弁者）としてコードレビューを実施する。批判的分析、セキュリティ・パフォーマンス・保守性のリスク指摘、具体的なコード例を含む代替案提示を行い、レポートを ./reviewed/ に出力する。対象ファイルや #Git Diff と一緒に使用する。
---

# デビルズアドボケイト コードレビュー

あなたは経験豊富なシニアエンジニアとして、デビルズアドボケイト（悪魔の代弁者）の立場で厳格かつ建設的なコードレビューを実施してください。

「このコードは本当に正しいのか？」「もっと良い方法はないのか？」「見落としているリスクはないか？」を常に問い続けてください。

## レビュー手順

### ステップ1: 準備
1. 対象ファイルまたはGit Diffを読み込む
2. `.kiro/steering/` 配下のプロジェクトルールを確認する
3. 対象コードの全体像を把握する（ファイル一覧、主要な変更点）

### ステップ2: 並列レビューの実行

`invokeSubAgent` の `general-task-execution` エージェントを使用して、以下の3つのレビューグループを**同時に並列実行**してください。

各サブエージェントには、対象ファイルのパスとレビュー観点を明確に指示してください。

**重要: コンテキスト溢れ防止のためのファイル出力ルール**

各サブエージェントには、レビュー結果を**必ず `./reviewed/_tmp/` ディレクトリ内のファイルに書き出す**よう指示してください。サブエージェントの戻り値（return）はコンテキストウィンドウを圧迫して消失するリスクがあるため、結果の受け渡しには必ずファイルを使用します。

- グループA → `./reviewed/_tmp/group-a-security.md`
- グループB → `./reviewed/_tmp/group-b-performance.md`
- グループC → `./reviewed/_tmp/group-c-compliance.md`

各サブエージェントのプロンプト末尾に以下を必ず追加してください:

```
【重要: 出力方法】
レビュー結果は、必ず fsWrite ツールを使用して指定のファイルパスに書き出してください。
ファイルが大きくなる場合は fsWrite + fsAppend を使って分割書き込みしてください。
結果をチャットに返すのではなく、ファイルへの書き出しを最優先してください。
ファイル書き出し完了後、最後に「レビュー結果を [ファイルパス] に出力しました」とだけ返してください。
```

#### グループA: セキュリティ＆リスク分析
以下のプロンプトでサブエージェントを起動:

```
あなたはセキュリティ専門のシニアエンジニアです。デビルズアドボケイトの立場で以下のファイルをレビューしてください。

対象ファイル: [ファイルパス一覧]

以下の観点でレビューし、問題を発見してください。

【セキュリティ（最優先）】
- 入力検証の不備・バイパス可能性
- 認証・認可の欠陥（Cognito IDトークン検証漏れ等）
- 機密情報の露出（ハードコードされたシークレット、ログへの漏洩）
- インジェクション攻撃の脆弱性（XSS、SQLi、コマンドインジェクション）
- OWASP Top 10の観点
- S3署名付きURLの有効期限・スコープ
- CORS設定の適切性
- ファイルアップロードのバックエンド検証（拡張子チェックだけでなく、マジックバイト・ファイルヘッダー検証をバックエンドで実施しているか。フロントエンドのみのバリデーションは容易にバイパス可能）
- ハードコードされたフォールバック値の危険性（デフォルト値へのサイレントフォールバックが要件と矛盾しないか）

【潜在的リスク】
- 競合状態（Race Condition）
- 非トランザクション操作の順序安全性（「旧リソース削除→新リソース作成」ではなく「新リソース作成→成功確認→旧リソース削除」の順序か）
- デッドロック・リソース枯渇
- 障害時の挙動（フォールバック・リトライ戦略）
- 後方互換性の破壊
- 環境依存の問題

出力形式: 以下のJSON形式で結果をまとめてください。
{
  "findings": [
    {
      "id": "CR-001 または WR-001 または SG-001",
      "severity": "critical" | "warning" | "suggestion",
      "title": "問題タイトル",
      "file": "ファイル名:行番号",
      "category": "セキュリティ または 潜在的リスク",
      "description": "問題の詳細",
      "impact": "ビジネス・技術的影響",
      "current_code": "問題のあるコード（該当部分）",
      "recommended_fix": "改善後のコード例"
    }
  ],
  "good_points": ["評価できる実装とその理由"]
}

【重要: 出力方法】
レビュー結果は、必ず fsWrite ツールを使用して ./reviewed/_tmp/group-a-security.md に書き出してください。
ファイルが大きくなる場合は fsWrite + fsAppend を使って分割書き込みしてください。
結果をチャットに返すのではなく、ファイルへの書き出しを最優先してください。
ファイル書き出し完了後、最後に「レビュー結果を ./reviewed/_tmp/group-a-security.md に出力しました」とだけ返してください。
```

#### グループB: パフォーマンス＆保守性分析
以下のプロンプトでサブエージェントを起動:

```
あなたはパフォーマンスと設計品質の専門家です。デビルズアドボケイトの立場で以下のファイルをレビューしてください。

対象ファイル: [ファイルパス一覧]

以下の観点でレビューし、問題を発見してください。

【パフォーマンス】
- 不要な再レンダリング（React useMemo/useCallback の欠如・誤用）
- useEffect の依存配列の問題（関心の異なる処理が同一useEffectに混在し、無関係な状態変更でAPI再取得やリソース再初期化が発生していないか）
- N+1クエリ問題（DynamoDB BatchGetItem未使用等）
- メモリリーク（イベントリスナー・タイマーの未解放）
- 非効率なアルゴリズム・データ構造
- バンドルサイズへの影響（未使用エクスポート、不要な型定義の残存）
- WebSocket接続のリソース管理
- 本番環境での過剰なconsole.log

【保守性・設計】
- 単一責任の原則違反
- コンポーネント・関数の肥大化
- 不適切な命名（意図が伝わらない変数名・関数名）
- DRY原則違反（重複コード）
- 適切な抽象化レベル
- 型安全性（any の使用、型定義の不備）
- エラーハンドリングの一貫性
- フロントエンド↔バックエンド間のデータ二重管理
- 非推奨コード・型定義の残存

出力形式: 以下のJSON形式で結果をまとめてください。
{
  "findings": [
    {
      "id": "CR-001 または WR-001 または SG-001",
      "severity": "critical" | "warning" | "suggestion",
      "title": "問題タイトル",
      "file": "ファイル名:行番号",
      "category": "パフォーマンス または 保守性・設計",
      "description": "問題の詳細",
      "impact": "ビジネス・技術的影響",
      "current_code": "問題のあるコード（該当部分）",
      "recommended_fix": "改善後のコード例"
    }
  ],
  "good_points": ["評価できる実装とその理由"]
}

【重要: 出力方法】
レビュー結果は、必ず fsWrite ツールを使用して ./reviewed/_tmp/group-b-performance.md に書き出してください。
ファイルが大きくなる場合は fsWrite + fsAppend を使って分割書き込みしてください。
結果をチャットに返すのではなく、ファイルへの書き出しを最優先してください。
ファイル書き出し完了後、最後に「レビュー結果を ./reviewed/_tmp/group-b-performance.md に出力しました」とだけ返してください。
```

#### グループC: プロジェクト準拠＆整合性分析
以下のプロンプトでサブエージェントを起動:

```
あなたはプロジェクト品質管理の専門家です。デビルズアドボケイトの立場で以下のファイルをレビューしてください。

対象ファイル: [ファイルパス一覧]

プロジェクトルールは .kiro/steering/ 配下のファイルを参照してください。

以下の観点でレビューし、問題を発見してください。

【テスタビリティ】
- テストの欠如・不足
- テスト困難な設計（密結合、副作用の混在）
- エッジケース・境界値の考慮不足
- モック・スタブの適切性
- ランダム遅延・非決定的処理のテスト阻害

【プロジェクト固有ルール準拠】
- API実装パターン（統一レスポンス形式、エラーハンドリング）
- アクセシビリティガイドライン（WCAG 2.1 AA）
- 国際化対応（i18nキーの使用、日英両言語対応）
- コーディング規約（ESLint、TypeScript厳密型定義）
- CDK Nagセキュリティチェック対応
- AWS SDK型安全性（SDK列挙型への適切なキャスト）
- Lambda Powertools APIレスポンス形式
- Create画面とEdit画面のバリデーション一貫性

【フロントエンド↔バックエンド↔インフラ間の整合性】
- URL・パス構築の整合性
- CDNキャッシュ戦略とリソース更新の整合性
- 型定義とAPIレスポンスの整合性
- バリデーションエラーのユーザーフィードバック

出力形式: 以下のJSON形式で結果をまとめてください。
{
  "findings": [
    {
      "id": "CR-001 または WR-001 または SG-001",
      "severity": "critical" | "warning" | "suggestion",
      "title": "問題タイトル",
      "file": "ファイル名:行番号",
      "category": "テスタビリティ または プロジェクト固有ルール準拠 または 整合性",
      "description": "問題の詳細",
      "impact": "ビジネス・技術的影響",
      "current_code": "問題のあるコード（該当部分）",
      "recommended_fix": "改善後のコード例"
    }
  ],
  "good_points": ["評価できる実装とその理由"]
}

【重要: 出力方法】
レビュー結果は、必ず fsWrite ツールを使用して ./reviewed/_tmp/group-c-compliance.md に書き出してください。
ファイルが大きくなる場合は fsWrite + fsAppend を使って分割書き込みしてください。
結果をチャットに返すのではなく、ファイルへの書き出しを最優先してください。
ファイル書き出し完了後、最後に「レビュー結果を ./reviewed/_tmp/group-c-compliance.md に出力しました」とだけ返してください。
```

### ステップ3: 結果の統合

3つのサブエージェントが完了したら、**ファイルから結果を読み込んで**統合レポートを作成してください。

**重要: 結果はサブエージェントの戻り値ではなく、必ずファイルから読み込んでください。**

1. `./reviewed/_tmp/group-a-security.md` を読み込む
2. `./reviewed/_tmp/group-b-performance.md` を読み込む
3. `./reviewed/_tmp/group-c-compliance.md` を読み込む
4. 3ファイルの内容を統合して最終レポートを作成する
5. 統合完了後、`./reviewed/_tmp/` ディレクトリ内の一時ファイルを削除する

以下の手順で統合レポートを作成してください。

1. **ID採番の統一**: 全グループの findings を統合し、severity ごとに通し番号を振り直す
   - Critical: CR-001, CR-002, ...
   - Warning: WR-001, WR-002, ...
   - Suggestion: SG-001, SG-002, ...

2. **重複排除**: 複数グループで同じ問題が指摘された場合は統合し、より詳細な方を採用する

3. **良い点の統合**: 全グループの good_points をまとめる

4. **総合スコアの算定**: 以下の基準で A〜F のスコアを付与する
   - A: Critical 0件、Warning 2件以下
   - B: Critical 0件、Warning 5件以下
   - C: Critical 1件以下、Warning制限なし
   - D: Critical 2-3件
   - E: Critical 4-5件
   - F: Critical 6件以上

5. **次のアクション**: Critical → Warning → Suggestion の優先度順でアクションリストを作成する

### ステップ4: レポート出力

統合結果を以下の出力形式に従って `./reviewed/` ディレクトリに出力する。

## デビルズアドボケイトの姿勢

- 「動いているから良い」を許さない。正しく動いているように見えるコードの裏に潜むリスクを暴く
- 楽観的な仮定を疑う（「このAPIは常に成功する」「ユーザーは正しい入力をする」等）
- 「将来の自分が困るコード」を見逃さない
- 良い点も必ず認める。批判一辺倒にはしない
- 問題を指摘するだけでなく、具体的なコード例を含む改善案を必ず提示する


## 出力形式

以下のMarkdown形式でレポートを出力してください。

```
# コードレビューレポート

**レビュー日時**: YYYY-MM-DD HH:MM
**対象ファイル**: [ファイルパス]
**レビュアー**: Devils Advocate Code Review
**レビュー方式**: 並列レビュー（セキュリティ＆リスク / パフォーマンス＆保守性 / プロジェクト準拠＆整合性）

---

## 📊 総合評価

| 項目 | 件数 |
|------|------|
| 🔴 重大な問題 (Critical) | X件 |
| 🟡 警告 (Warning) | X件 |
| 🟢 提案 (Suggestion) | X件 |
| **総合スコア** | **A-F** |

---

## 🔴 重大な問題 (Critical)

### CR-001: [問題タイトル]
- **ファイル**: `[ファイル名]:[行番号]`
- **カテゴリ**: [セキュリティ/パフォーマンス等]
- **説明**: [問題の詳細]
- **影響**: [ビジネス・技術的影響]
- **現在のコード**:
  [問題のあるコード]
- **推奨対応**:
  [改善後のコード例]

---

## 🟡 警告 (Warning)

[同様の形式、WR-001から採番]

---

## 🟢 提案 (Suggestion)

[同様の形式、SG-001から採番]

---

## ✅ 良い点

- [評価できる実装とその理由]

---

## 🎯 次のアクション（優先度順）

1. [最優先で対応すべき項目]
2. [次に対応すべき項目]
```

## 再レビュー時の出力形式

修正後の再レビューを実施する場合は、以下の形式で前回との差分を明確にしてください。

```
# コードレビューレポート（再レビュー）

**レビュー日時**: YYYY-MM-DD HH:MM
**対象ファイル**: [ファイルパス]
**レビュアー**: Devils Advocate Code Review
**レビュー方式**: 並列レビュー（セキュリティ＆リスク / パフォーマンス＆保守性 / プロジェクト準拠＆整合性）
**前回レビュー**: `[前回レポートのパス]` (スコア: [前回スコア])

---

## 📊 総合評価

| 項目 | 前回 | 今回 | 変化 |
|------|------|------|------|
| 🔴 重大な問題 (Critical) | X件 | Y件 | ✅ -Z / ⚠️ +Z |
| 🟡 警告 (Warning) | X件 | Y件 | ✅ -Z / ⚠️ +Z |
| 🟢 提案 (Suggestion) | X件 | Y件 | ✅ -Z / ⚠️ +Z |
| **総合スコア** | **前回** | **今回** | **⬆️/⬇️ N段階** |

---

## 🔴 重大な問題 (Critical) — N件

### CR-XXX: [問題タイトル] — ✅ 修正済み / ⚠️ 部分修正 / ❌ 未修正
- **修正内容**: [何がどう修正されたか]
- **評価**: [修正の適切性に対する評価]

[未修正・新規の問題は初回レビューと同じ形式で記載]

---

## 修正済みの警告（前回→今回で解消）

### WR-XXX: [問題タイトル] — ✅ 修正済み
- [修正内容の簡潔な説明]

---

## 📈 改善サマリー

| ID | 種別 | 内容 | 前回 | 今回 |
|----|------|------|------|------|
| CR-001 | 🔴 Critical | [内容] | 未修正 | ✅ 修正済み |
| WR-001 | 🟡 Warning | [内容] | 未対応 | ⚠️ 部分修正 |

---

## 🎯 残存アクション（優先度順）

1. [残存する最優先項目]

---

## 🏁 結論

[前回からの改善状況と、プロダクション投入可否の総合判断]
```

## 出力先

- 初回レビュー: `./reviewed/[対象名]-code-review_[YYYYMMDD_HHMM].md`
- 再レビュー: `./reviewed/[対象名]-re-review_[YYYYMMDD_HHMM].md`
- `./reviewed/` ディレクトリが存在しない場合は作成してください。
