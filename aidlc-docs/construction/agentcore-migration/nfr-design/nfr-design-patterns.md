# NFR設計パターン: AgentCore Runtime Migration

## 1. 概要

本ドキュメントは、AgentCore Runtime移行におけるNFR設計パターンを定義します。
NFR要件に基づき、レジリエンス、スケーラビリティ、パフォーマンス、セキュリティ、可観測性の各パターンを設計します。

---

## 2. レジリエンスパターン

### 2.1 エラーハンドリング戦略

**決定**: リトライなし（即座にエラー表示）

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   フロントエンド   │────▶│  AgentCore Runtime │────▶│   エラー発生    │
└─────────────────┘     └──────────────────┘     └─────────────────┘
                                                          │
                                                          ▼
                              ┌──────────────────────────────────────┐
                              │  即座にエラーUI表示                    │
                              │  - エラーメッセージ表示                │
                              │  - 手動リトライボタン提供              │
                              │  - セッション状態保持                  │
                              └──────────────────────────────────────┘
```

**実装パターン**:
```typescript
// フロントエンド エラーハンドリング
try {
  const response = await invokeAgentCore(payload);
  return response;
} catch (error) {
  // 即座にエラー表示（自動リトライなし）
  setError({
    message: getErrorMessage(error),
    canRetry: true,  // 手動リトライ可能
    timestamp: Date.now()
  });
  // セッション状態は保持（会話履歴は失われない）
}
```

**理由**:
- シンプルな実装
- ユーザーに制御を委ねる
- AgentCore Memory により会話履歴は保持される

### 2.2 タイムアウト戦略

**決定**: 120秒タイムアウト

```
┌─────────────────┐     ┌──────────────────┐
│   フロントエンド   │────▶│  AgentCore Runtime │
│  timeout: 120s  │     │                  │
└─────────────────┘     └──────────────────┘
         │
         ▼ 120秒経過
┌─────────────────────────────────────────┐
│  タイムアウトエラー表示                    │
│  - "応答に時間がかかっています"            │
│  - 手動リトライボタン                     │
└─────────────────────────────────────────┘
```

**実装パターン**:
```typescript
const AGENT_TIMEOUT_MS = 120_000; // 120秒

const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), AGENT_TIMEOUT_MS);

try {
  const response = await fetch(agentEndpoint, {
    signal: controller.signal,
    // ...
  });
} finally {
  clearTimeout(timeoutId);
}
```

**理由**:
- 複雑な会話応答に十分な時間を確保
- Bedrock Claude 4.5 Haiku の応答時間を考慮
- ユーザー体験とのバランス

### 2.3 フォールバック戦略

**決定**: フォールバックなし（AgentCore Runtime可用性に依存）

**理由**:
- コスト最適化優先
- 小規模利用想定
- AgentCore Runtime の高可用性に依存

---

## 3. スケーラビリティパターン

### 3.1 自動スケーリング

**決定**: AgentCore Runtime 自動スケーリングに完全依存

```
┌─────────────────────────────────────────────────────────────┐
│                    AgentCore Runtime                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Instance 0  │  │  Instance 1  │  │  Instance N  │  ...   │
│  │  (idle時0)   │  │  (需要時)    │  │  (需要時)    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  スケーリング: 自動（AgentCore管理）                          │
│  最小: 0（コスト最適化）                                      │
│  最大: AgentCoreデフォルト                                   │
└─────────────────────────────────────────────────────────────┘
```

**理由**:
- 運用負荷軽減
- コスト最適化（アイドル時0）
- 小規模利用に適切

### 3.2 コールドスタート許容

**決定**: コールドスタート許容（Provisioned Concurrency不使用）

**理由**:
- コスト最優先
- 小規模利用（同時10セッション未満）
- ユーザー体験への影響は許容範囲

---

## 4. パフォーマンスパターン

### 4.1 ローディング表示

**決定**: 現状維持（既存のローディングUI）

```
┌─────────────────────────────────────────┐
│           会話画面                       │
│  ┌─────────────────────────────────┐   │
│  │  NPC: こんにちは...              │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │  User: 製品について...           │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │  ⏳ 応答を生成中...              │   │  ← 既存ローディングUI
│  │  [スピナーアニメーション]         │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

**理由**:
- 既存実装の再利用
- 開発コスト削減
- ユーザー体験は十分

### 4.2 データフロー最適化

**決定**: AgentCore Memory による一元管理

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   フロントエンド   │────▶│  AgentCore Runtime │────▶│ AgentCore Memory │
└─────────────────┘     └──────────────────┘     └─────────────────┘
                                │                         │
                                │  会話履歴自動保存        │
                                │  メトリクス保存          │
                                │  ゴール状態保存          │
                                ▼                         │
                        ┌──────────────────┐              │
                        │  Bedrock Claude   │              │
                        │  3.5 Haiku       │              │
                        └──────────────────┘              │
                                                          │
                        ┌──────────────────┐              │
                        │  評価画面API      │◀─────────────┘
                        │  (ListEvents)    │
                        └──────────────────┘
```

---

## 5. セキュリティパターン

### 5.1 認証フロー

**決定**: AgentCore Identity Inbound Auth（フロントエンド直接呼び出しのみ）

```
┌─────────────────────────────────────────────────────────────────────┐
│  フロントエンド直接呼び出し（AgentCore Identity必要）                  │
│                                                                     │
│  ┌─────────────┐  JWT   ┌──────────────────┐  検証  ┌────────────┐ │
│  │ フロントエンド │──────▶│ AgentCore Identity │──────▶│ Cognito    │ │
│  │ (Amplify)   │       │ (Inbound Auth)   │       │ User Pool  │ │
│  └─────────────┘       └──────────────────┘       └────────────┘ │
│         │                      │                                  │
│         │                      ▼                                  │
│         │              ┌──────────────────┐                       │
│         └─────────────▶│ AgentCore Runtime │                       │
│                        │ (NPC/Scoring)    │                       │
│                        └──────────────────┘                       │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  Step Functions経由呼び出し（IAMロール認証）                          │
│                                                                     │
│  ┌─────────────┐  IAM   ┌──────────────────┐                       │
│  │ Step Functions│──────▶│ AgentCore Runtime │                       │
│  │ (IAM Role)  │       │ (Analysis)       │                       │
│  └─────────────┘       └──────────────────┘                       │
│                                                                     │
│  ※ AgentCore Identity不要（IAMロールで認証）                         │
└─────────────────────────────────────────────────────────────────────┘
```

**適用対象**:
| エージェント | 呼び出し元 | 認証方式 |
|------------|-----------|---------|
| NPC会話エージェント | フロントエンド | AgentCore Identity (JWT) |
| スコアリングエージェント | フロントエンド | AgentCore Identity (JWT) |
| フィードバック分析エージェント | Step Functions | IAMロール |
| 動画分析エージェント | Step Functions | IAMロール |
| 音声分析エージェント | Step Functions | IAMロール |

### 5.2 データ分離

**決定**: マイクロVM分離 + セッションID分離

```
┌─────────────────────────────────────────────────────────────┐
│                    AgentCore Runtime                        │
│  ┌─────────────────┐  ┌─────────────────┐                  │
│  │   MicroVM A     │  │   MicroVM B     │                  │
│  │  ┌───────────┐  │  │  ┌───────────┐  │                  │
│  │  │ Session 1 │  │  │  │ Session 2 │  │                  │
│  │  │ User: A   │  │  │  │ User: B   │  │                  │
│  │  └───────────┘  │  │  └───────────┘  │                  │
│  └─────────────────┘  └─────────────────┘                  │
│                                                             │
│  分離レベル:                                                 │
│  - プロセス分離（MicroVM）                                   │
│  - データ分離（セッションID + ユーザーID）                    │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 暗号化

**決定**: 転送時・保存時暗号化

| 項目 | 暗号化方式 |
|-----|----------|
| 転送時 | TLS 1.2+ |
| AgentCore Memory | AWS管理キー |
| S3 (分析結果) | SSE-S3 |

---

## 6. 可観測性パターン

### 6.1 メトリクス収集

**決定**: AgentCore Observability 基本メトリクス

```
┌─────────────────────────────────────────────────────────────┐
│                 AgentCore Observability                     │
│                                                             │
│  自動収集メトリクス:                                         │
│  - 呼び出し回数 (Invocations)                               │
│  - エラー率 (ErrorRate)                                     │
│  - レイテンシー (Latency)                                   │
│  - 同時実行数 (ConcurrentExecutions)                        │
│                                                             │
│         │                                                   │
│         ▼                                                   │
│  ┌─────────────────┐                                        │
│  │  CloudWatch     │                                        │
│  │  Metrics        │                                        │
│  └─────────────────┘                                        │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 ログ戦略

**決定**: CloudWatch Logs（30日保持）

```
┌─────────────────────────────────────────────────────────────┐
│                    ログ構成                                  │
│                                                             │
│  ┌─────────────────┐     ┌─────────────────┐               │
│  │ AgentCore Runtime│────▶│ CloudWatch Logs │               │
│  │ (INFO/DEBUG)    │     │ (30日保持)      │               │
│  └─────────────────┘     └─────────────────┘               │
│                                                             │
│  ログレベル:                                                 │
│  - 本番: INFO                                               │
│  - 開発: DEBUG                                              │
│                                                             │
│  ログ内容:                                                   │
│  - リクエスト/レスポンス概要                                  │
│  - エラー詳細                                                │
│  - パフォーマンスメトリクス                                   │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 アラーム設定

**決定**: エラー率閾値アラーム

| アラーム | 閾値 | アクション |
|---------|-----|----------|
| エラー率 | 10% 超過 | SNS通知 |
| レイテンシー | 60秒 超過 | SNS通知 |

---

## 7. データ保存パターン

### 7.1 AgentCore Memory 活用

**決定**: 365日間保持（Short-Term Memory）

```
┌─────────────────────────────────────────────────────────────┐
│                 AgentCore Memory                            │
│                                                             │
│  保存データ:                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  セッションID: session-xxx                           │   │
│  │  ├── 会話履歴 (messages)                            │   │
│  │  ├── メトリクス履歴 (metrics)                        │   │
│  │  ├── ゴール状態 (goals)                             │   │
│  │  └── セッションメタデータ (metadata)                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  保存期間: 365日間                                          │
│  料金: $0.25 / 1,000イベント                                │
│  月額想定: 約$0.50（100セッション/月）                       │
│                                                             │
│  アクセス方法:                                               │
│  - エージェント内: context.memory                           │
│  - 外部API: ListEvents API                                 │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 S3 活用（大容量データ）

**決定**: 分析結果はS3にJSON保存

```
┌─────────────────────────────────────────────────────────────┐
│                      S3 バケット                            │
│                                                             │
│  sessions/                                                  │
│  └── {session-id}/                                         │
│      ├── feedback.json      # フィードバック分析結果         │
│      ├── video-analysis.json # 動画分析結果                 │
│      └── reference-check.json # リファレンスチェック結果     │
│                                                             │
│  保存期間: 無期限（手動削除まで）                             │
│  暗号化: SSE-S3                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 設計決定サマリー

| カテゴリ | パターン | 決定内容 |
|---------|---------|---------|
| レジリエンス | エラーハンドリング | リトライなし（即座にエラー表示） |
| レジリエンス | タイムアウト | 120秒 |
| レジリエンス | フォールバック | なし |
| スケーラビリティ | スケーリング | AgentCore自動スケーリング |
| スケーラビリティ | コールドスタート | 許容（Provisioned Concurrency不使用） |
| パフォーマンス | ローディング | 現状維持（既存UI） |
| セキュリティ | 認証 | AgentCore Identity（フロントエンド直接のみ） |
| セキュリティ | データ分離 | MicroVM + セッションID |
| 可観測性 | メトリクス | AgentCore Observability基本 |
| 可観測性 | ログ | CloudWatch Logs（30日） |
| データ保存 | 会話履歴 | AgentCore Memory（365日） |
| データ保存 | 分析結果 | S3（JSON） |

---

**作成日**: 2026-01-08
**バージョン**: 1.0
