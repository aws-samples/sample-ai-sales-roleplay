# デプロイメントアーキテクチャ: AgentCore Runtime Migration

## 1. 概要

本ドキュメントは、AgentCore Runtime移行のデプロイメントアーキテクチャを定義します。

---

## 2. アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              フロントエンド                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         React Application                               │   │
│  │                         (Amplify Hosting)                               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                    │                              │                             │
│                    │ JWT                          │ JWT                         │
│                    ▼                              ▼                             │
└─────────────────────────────────────────────────────────────────────────────────┘
                     │                              │
        ┌────────────┘                              └────────────┐
        │                                                        │
        ▼                                                        ▼
┌───────────────────────────────────┐    ┌───────────────────────────────────────┐
│     AgentCore Identity            │    │         API Gateway                   │
│  ┌─────────────────────────────┐  │    │  ┌─────────────────────────────────┐  │
│  │  Custom JWT Authorizer      │  │    │  │  Cognito Authorizer             │  │
│  │  (Cognito User Pool)        │  │    │  │  (既存)                         │  │
│  └─────────────────────────────┘  │    │  └─────────────────────────────────┘  │
└───────────────────────────────────┘    └───────────────────────────────────────┘
        │                                            │
        ▼                                            ▼
┌───────────────────────────────────┐    ┌───────────────────────────────────────┐
│     AgentCore Runtime             │    │         Lambda                        │
│  ┌─────────────────────────────┐  │    │  ┌─────────────────────────────────┐  │
│  │  npc-conversation-agent     │  │    │  │  evaluation-api                 │  │
│  │  (NPC会話)                  │  │    │  │  (評価画面API)                   │  │
│  └─────────────────────────────┘  │    │  └─────────────────────────────────┘  │
│  ┌─────────────────────────────┐  │    └───────────────────────────────────────┘
│  │  realtime-scoring-agent     │  │                    │
│  │  (スコアリング)              │  │                    │
│  └─────────────────────────────┘  │                    │
└───────────────────────────────────┘                    │
        │                                                │
        ▼                                                ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                           AgentCore Memory                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐  │
│  │  会話履歴 | メトリクス履歴 | ゴール状態 | セッションメタデータ              │  │
│  │  保持期間: 365日 (Short-Term Memory)                                    │  │
│  └─────────────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                           Amazon Bedrock                                      │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐            │
│  │  Claude 4.5 Haiku           │  │  Claude Sonnet 4.5          │            │
│  │  (会話、スコアリング)        │  │  (フィードバック)            │            │
│  └─────────────────────────────┘  └─────────────────────────────┘            │
└───────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Step Functions アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Session Analysis Step Functions                         │
│                                                                                 │
│  ┌─────────────┐                                                               │
│  │  セッション   │                                                               │
│  │  終了トリガー │                                                               │
│  └─────────────┘                                                               │
│         │                                                                       │
│         ▼                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         Parallel State                                  │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │   │
│  │  │ AgentCore Runtime│  │ AgentCore Runtime│  │ AgentCore Runtime│         │   │
│  │  │ feedback-analysis│  │ video-analysis  │  │ audio-analysis  │         │   │
│  │  │ -agent          │  │ -agent          │  │ -agent          │         │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘         │   │
│  │         │                    │                    │                    │   │
│  │         ▼                    ▼                    ▼                    │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │   │
│  │  │  S3 保存        │  │  S3 保存        │  │  S3 保存        │         │   │
│  │  │  feedback.json  │  │  video.json     │  │  audio.json     │         │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│         │                                                                       │
│         ▼                                                                       │
│  ┌─────────────────┐                                                           │
│  │  完了通知        │                                                           │
│  └─────────────────┘                                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. データフローアーキテクチャ

### 4.1 会話フロー

```
User → Frontend → AgentCore Identity → AgentCore Runtime (npc-conversation)
                                              │
                                              ├──▶ AgentCore Memory (会話履歴保存)
                                              │
                                              └──▶ Bedrock Claude 4.5 Haiku
                                                          │
                                                          ▼
                                              NPC応答 → Frontend → User
```

### 4.2 スコアリングフロー

```
User発言 → Frontend → AgentCore Identity → AgentCore Runtime (realtime-scoring)
                                                   │
                                                   ├──▶ AgentCore Memory (メトリクス保存)
                                                   │
                                                   └──▶ Bedrock Claude 4.5 Haiku
                                                               │
                                                               ▼
                                                   スコア → Frontend → UI更新
```

### 4.3 評価画面データ取得フロー

```
User → Frontend → API Gateway → Lambda (evaluation-api)
                                       │
                                       ├──▶ AgentCore Memory (ListEvents)
                                       │         │
                                       │         ▼
                                       │    会話履歴、メトリクス
                                       │
                                       └──▶ S3
                                                 │
                                                 ▼
                                       フィードバック、動画分析結果
                                                 │
                                                 ▼
                                       Frontend → 評価画面表示
```

---

## 5. CDKスタック構成

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         InfrastructureStack                                     │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  既存リソース（継続使用）                                                  │   │
│  │  - Cognito User Pool                                                    │   │
│  │  - DynamoDB (Scenarios, NPC, Users)                                     │   │
│  │  - S3 (Videos, Audio, Sessions)                                         │   │
│  │  - API Gateway (その他エンドポイント)                                     │   │
│  │  - Step Functions (更新)                                                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  新規リソース（追加）                                                     │   │
│  │  - AgentCore Runtime × 5                                                │   │
│  │    - npc-conversation-agent                                             │   │
│  │    - realtime-scoring-agent                                             │   │
│  │    - feedback-analysis-agent                                            │   │
│  │    - video-analysis-agent                                               │   │
│  │    - audio-analysis-agent                                               │   │
│  │  - IAM Roles (AgentCore用)                                              │   │
│  │  - Lambda (evaluation-api)                                              │   │
│  │  - API Gateway エンドポイント (/evaluation/*)                            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  削除リソース                                                            │   │
│  │  - Lambda (bedrock, scoring, sessionAnalysis/*, audioAnalysis/*)        │   │
│  │  - API Gateway エンドポイント (/bedrock/*, /scoring/*)                   │   │
│  │  - DynamoDB (ConversationHistory, SessionMetrics)                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 環境別デプロイ構成

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              AWS Account                                        │
│                                                                                 │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐     │
│  │      dev環境        │  │    staging環境      │  │      prod環境       │     │
│  │                     │  │                     │  │                     │     │
│  │  AgentCore Runtime  │  │  AgentCore Runtime  │  │  AgentCore Runtime  │     │
│  │  - dev-npc-*        │  │  - staging-npc-*    │  │  - prod-npc-*       │     │
│  │  - dev-scoring-*    │  │  - staging-scoring-*│  │  - prod-scoring-*   │     │
│  │  - dev-feedback-*   │  │  - staging-feedback-│  │  - prod-feedback-*  │     │
│  │  - dev-video-*      │  │  - staging-video-*  │  │  - prod-video-*     │     │
│  │  - dev-audio-*      │  │  - staging-audio-*  │  │  - prod-audio-*     │     │
│  │                     │  │                     │  │                     │     │
│  │  Cognito User Pool  │  │  Cognito User Pool  │  │  Cognito User Pool  │     │
│  │  (dev)              │  │  (staging)          │  │  (prod)             │     │
│  │                     │  │                     │  │                     │     │
│  │  DynamoDB Tables    │  │  DynamoDB Tables    │  │  DynamoDB Tables    │     │
│  │  (dev-*)            │  │  (staging-*)        │  │  (prod-*)           │     │
│  │                     │  │                     │  │                     │     │
│  │  S3 Buckets         │  │  S3 Buckets         │  │  S3 Buckets         │     │
│  │  (dev-*)            │  │  (staging-*)        │  │  (prod-*)           │     │
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. デプロイ手順

### 7.1 CDKデプロイコマンド

```bash
# 開発環境
cd cdk
npm run deploy:dev

# ステージング環境
npm run deploy:staging

# 本番環境
npm run deploy:prod
```

### 7.2 デプロイ順序

1. **AgentCore Runtime作成**
   - IAMロール作成
   - エージェントコードS3アップロード
   - CfnRuntime作成

2. **評価画面API作成**
   - Lambda作成
   - API Gatewayエンドポイント追加

3. **Step Functions更新**
   - Lambda呼び出し → AgentCore Runtime呼び出しに変更

4. **旧リソース削除**
   - Lambda削除
   - API Gatewayエンドポイント削除
   - DynamoDBテーブル削除

5. **フロントエンド更新**
   - 環境変数更新
   - ビルド・デプロイ

---

## 8. ロールバック手順

### 8.1 ロールバック戦略

**注意**: ビッグバン移行のため、ロールバックは手動で旧リソースを再作成する必要があります。

```bash
# 旧バージョンのCDKコードをチェックアウト
git checkout <previous-commit>

# 旧リソースを再デプロイ
npm run deploy:dev
```

### 8.2 データ復旧

- AgentCore Memory: 365日間保持のため、データは保持される
- S3: 変更なし、データは保持される
- DynamoDB: 削除前にバックアップを取得

---

## 9. 監視・アラート構成

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         CloudWatch                                              │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  メトリクス                                                              │   │
│  │  - AgentCore Invocations                                                │   │
│  │  - AgentCore Errors                                                     │   │
│  │  - AgentCore Latency                                                    │   │
│  │  - Evaluation API Errors                                                │   │
│  │  - Evaluation API Latency                                               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  アラーム                                                                │   │
│  │  - AgentCore Error Rate > 10% → SNS通知                                 │   │
│  │  - AgentCore Latency > 60s → SNS通知                                    │   │
│  │  - Evaluation API Error Rate > 5% → SNS通知                             │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  ログ                                                                   │   │
│  │  - /aws/bedrock-agentcore/* (30日保持)                                  │   │
│  │  - /aws/lambda/evaluation-api (30日保持)                                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

**作成日**: 2026-01-08
**バージョン**: 1.0
