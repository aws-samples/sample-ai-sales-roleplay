# E2Eテスト計画: シナリオの実施

## 概要

本計画は、AI営業ロールプレイシステムにおける「シナリオの実施」機能のE2Eテストを定義します。

## テスト対象スコープ

「シナリオの実施」は以下のユーザーフローを含みます：

1. **シナリオ選択** - ScenarioSelectPage
2. **会話セッション開始** - ConversationPage（商談開始）
3. **NPC対話** - AgentCore Runtime経由のNPC会話
4. **リアルタイム評価** - メトリクス更新、ゴール達成状況
5. **セッション終了** - 結果保存
6. **結果表示** - ResultPage（フィードバック、スコア表示）

## スコープ外

- 音声認識（マイク入力）テスト
- 動画録画機能（VideoManager）テスト
- 多言語テスト（英語）

## テスト方針

- **テスト環境**: ステージング環境への接続を伴う統合テスト
- **言語**: 日本語のみ
- **優先度**: ハッピーパス（正常系）を優先

## テスト環境要件

- Playwright 1.55.0
- Node.js 22.x以上
- ステージング環境URL（環境変数で設定）
- 認証: AWS Cognito（テスト用アカウント使用）

---

## テスト計画ステップ

### Phase 1: テスト基盤の準備

- [x] **1.1** Playwright設定の更新（ステージング環境対応）
- [x] **1.2** テスト用Cognitoアカウントの認証フロー実装
- [x] **1.3** テストヘルパー関数の作成（ログイン、ページ遷移）
- [x] **1.4** 環境変数設定ファイルの作成

### Phase 2: シナリオ選択画面のテスト

- [x] **2.1** シナリオ一覧の表示テスト
  - シナリオカードが正しく表示されること
  - 難易度、業界、NPC情報が表示されること
- [x] **2.2** フィルタリング機能のテスト
  - 難易度フィルター
  - 業界フィルター
  - 検索機能
- [x] **2.3** お気に入り機能のテスト
  - お気に入り追加/削除
  - お気に入りのみ表示
- [x] **2.4** シナリオ選択から会話画面への遷移テスト

### Phase 3: 会話セッションのテスト

- [x] **3.1** セッション開始テスト
  - 「商談を開始」ボタンクリック
  - セッションIDの生成確認
  - 初期メッセージの表示
- [x] **3.2** メッセージ送信テスト
  - テキスト入力による送信
  - NPC応答の受信と表示
  - メッセージ履歴の更新
- [x] **3.3** メトリクス表示テスト
  - 怒りメーター、信頼度、進捗度の表示
  - メトリクス更新のアニメーション
- [x] **3.4** ゴール達成状況の表示テスト
  - ゴールパネルの表示
  - 達成状況の更新

### Phase 4: 音声設定のテスト

- [x] **4.1** 音声設定パネルのテスト
  - 音声ON/OFF切り替え
  - 音量調整
  - 読み上げ速度調整

※ 音声認識（マイク入力）テストはスコープ外

### Phase 5: セッション終了のテスト

- [x] **5.1** セッション終了条件のテスト
  - 手動終了（終了ボタン）
- [x] **5.2** 結果画面への遷移テスト
  - セッションデータの保存確認
  - ResultPageへの正常遷移

※ 動画録画機能テストはスコープ外

### Phase 6: 結果画面のテスト

- [x] **6.1** 総合スコア表示テスト
  - スコアの表示
  - パフォーマンスレベルの表示
- [x] **6.2** 詳細フィードバック表示テスト
  - レーダーチャートの表示
  - 改善提案の表示
- [x] **6.3** 会話履歴タブのテスト
  - メッセージ一覧の表示
- [x] **6.4** コンプライアンス違反タブのテスト
  - 違反リストの表示（該当する場合）
- [x] **6.5** ナビゲーションテスト
  - ホームへ戻る
  - 同じシナリオで再挑戦

### Phase 7: エラーハンドリングのテスト（低優先度）

※ 正常系を優先するため、以下は時間があれば実施

- [ ] **7.1** API エラー時の表示テスト
  - シナリオ取得失敗
  - セッション作成失敗
  - NPC応答エラー
- [ ] **7.2** ネットワークエラー時の表示テスト
- [ ] **7.3** 認証エラー時のリダイレクトテスト

### Phase 8: アクセシビリティテスト

- [x] **8.1** キーボードナビゲーションテスト
  - Tab キーによるフォーカス移動
  - Enter キーによるアクション実行
- [x] **8.2** ARIA属性の検証テスト
  - aria-label の存在確認
  - aria-live 領域の動作確認
- [ ] **8.3** フォーカス管理テスト（未実装）
  - モーダル表示時のフォーカストラップ
  - ページ遷移時のフォーカス位置

### Phase 9: レスポンシブデザインテスト

- [x] **9.1** デスクトップ表示テスト（Desktop Chrome）
- [x] **9.2** モバイル表示テスト（Mobile Chrome, Mobile Safari）
- [x] **9.3** タブレット表示テスト

---

## 成果物

以下のファイルを作成済み：

1. ✅ `frontend/src/tests/e2e/scenario-execution.spec.ts` - メインテストファイル
2. ✅ `frontend/src/tests/e2e/helpers/auth.ts` - 認証ヘルパー
3. ✅ `frontend/src/tests/e2e/helpers/navigation.ts` - ナビゲーションヘルパー
4. ✅ `frontend/src/tests/e2e/helpers/index.ts` - ヘルパーエクスポート
5. ✅ `frontend/playwright.config.ts` - 設定更新（ステージング環境対応）
6. ✅ `frontend/.env.test.example` - テスト用環境変数サンプル

## テスト実行方法

### 環境変数の設定

1. `.env.test.example` を `.env.test` にコピー
2. 以下の環境変数を設定：
   - `E2E_BASE_URL`: ステージング環境のURL
   - `E2E_USERNAME`: テスト用Cognitoユーザー名
   - `E2E_PASSWORD`: テスト用Cognitoパスワード
   - `E2E_USER_POOL_ID`: Cognito User Pool ID
   - `E2E_CLIENT_ID`: Cognito Client ID

### テスト実行コマンド

```bash
# ステージング環境に対してE2Eテストを実行
cd frontend
npm run test:e2e

# 特定のテストファイルのみ実行
npx playwright test scenario-execution.spec.ts

# UIモードで実行（デバッグ用）
npx playwright test --ui

# ヘッドレスモードで実行
npx playwright test --headed
```

## 実装状況サマリー

| Phase | 状態 | 備考 |
|-------|------|------|
| Phase 1: テスト基盤 | ✅ 完了 | |
| Phase 2: シナリオ選択 | ✅ 完了 | |
| Phase 3: 会話セッション | ✅ 完了 | |
| Phase 4: 音声設定 | ✅ 完了 | マイク入力テストはスコープ外 |
| Phase 5: セッション終了 | ✅ 完了 | 動画録画テストはスコープ外 |
| Phase 6: 結果画面 | ✅ 完了 | |
| Phase 7: エラーハンドリング | ⏸️ 未実装 | 低優先度 |
| Phase 8: アクセシビリティ | 🔶 一部完了 | 8.3 フォーカス管理テスト未実装 |
| Phase 9: レスポンシブ | ✅ 完了 | |

---

## 自動テスト実行結果

### 実行日時
2026年2月4日

### テスト環境
- **エンドポイント**: https://d3vdpodkd9cyhf.cloudfront.net
- **テストユーザー**: e2e-test@example.com
- **Cognito User Pool**: us-west-2_vEu18uWVH
- **テストフレームワーク**: Playwright 1.55.0

### 自動テスト結果サマリー

| カテゴリ | 結果 | 件数 |
|---------|------|------|
| 成功 | ✅ PASS | 12件 |
| スキップ | ⏭️ SKIP | 15件 |
| 失敗 | ❌ FAIL | 0件 |

### 成功したテスト（12件）

#### Phase 2: シナリオ選択画面（6件）
- ✅ シナリオカードが正しく表示されること
- ✅ 難易度、業界、NPC情報が表示されること
- ✅ 難易度フィルターが機能すること
- ✅ 検索機能が機能すること
- ✅ お気に入り追加/削除ができること
- ✅ シナリオを選択して会話画面に遷移できること

#### Phase 8: アクセシビリティ（3件）
- ✅ Tabキーでフォーカス移動ができること
- ✅ Enterキーでアクション実行ができること
- ✅ aria-label属性が適切に設定されていること

#### Phase 9: レスポンシブデザイン（3件）
- ✅ デスクトップサイズで正しく表示されること
- ✅ モバイルサイズで正しく表示されること
- ✅ タブレットサイズで正しく表示されること

### スキップされたテスト（15件）

以下のテストは、ヘッドレスブラウザでカメラにアクセスできないため、自動テストではスキップされています。

#### Phase 3: 会話セッション（4件）
- ⏭️ 「商談を開始」ボタンクリックでセッションが開始されること
- ⏭️ テキスト入力でメッセージを送信できること
- ⏭️ 怒りメーター、信頼度、進捗度が表示されること
- ⏭️ ゴールパネルが表示されること

#### Phase 4: 音声設定（2件）
- ⏭️ 音声ON/OFF切り替えができること
- ⏭️ 音量調整ができること

#### Phase 5: セッション終了（2件）
- ⏭️ 手動終了（終了ボタン）でセッションを終了できること
- ⏭️ セッション終了後に結果ページに遷移すること

#### Phase 6: 結果画面（7件）
- ⏭️ スコアが表示されること
- ⏭️ パフォーマンスレベルが表示されること
- ⏭️ レーダーチャートが表示されること
- ⏭️ 改善提案が表示されること
- ⏭️ 会話履歴タブでメッセージ一覧が表示されること
- ⏭️ コンプライアンスタブが表示されること
- ⏭️ ホームへ戻るボタンが機能すること

### スキップ理由と対策

**理由**: ヘッドレスブラウザ（Playwright）ではカメラデバイスにアクセスできないため、「商談を開始」ボタンが有効化されません。アプリケーションはカメラ初期化が完了するまでボタンを無効化しています。

**対策案**:
1. **アプリケーション側の修正**: カメラ初期化のタイムアウト処理を追加し、タイムアウト後は「録画なし」モードで商談を開始できるようにする（VideoRecorder.tsxに実装済み、ステージング環境へのデプロイが必要）
2. **テスト環境の整備**: カメラデバイスをモックするPlaywrightの設定を追加
3. **手動テストの実施**: カメラが必要なテストは手動で実施

---

## 手動テスト実行結果

### 実行日時
2026年2月4日

### テスト環境
- **エンドポイント**: https://d3vdpodkd9cyhf.cloudfront.net
- **テストユーザー**: e2e-test@example.com
- **Cognito User Pool**: us-west-2_vEu18uWVH

### 手動テスト結果サマリー

| Phase | 結果 | 備考 |
|-------|------|------|
| Phase 2: シナリオ選択 | ✅ PASS | 17件のシナリオ表示、フィルター機能動作確認 |
| Phase 3: 会話セッション | ✅ PASS | セッション開始、NPC初期メッセージ表示、メトリクス表示確認 |
| Phase 4: 音声設定 | ✅ PASS | 音声ON/OFF、音量スライダー表示確認 |
| Phase 5: セッション終了 | ✅ PASS | 商談終了ボタン、結果画面への遷移確認 |
| Phase 6: 結果画面 | ✅ PASS | 全タブ（評価サマリー、対話履歴、コンプライアンス、表情・身振り分析、リファレンスチェック）表示確認 |
| Phase 8: アクセシビリティ | ✅ PASS | キーボードナビゲーション（Tab/Enter）動作確認 |

### 詳細テスト結果

#### Phase 2: シナリオ選択画面
- ✅ シナリオ一覧表示（17件）
- ✅ 難易度フィルター表示
- ✅ 業界フィルター表示
- ✅ 検索ボックス表示
- ✅ お気に入りスイッチ表示
- ✅ シナリオカード情報（タイトル、説明、NPC情報、難易度）表示

#### Phase 3: 会話セッション
- ✅ セッション開始（「商談を開始」ボタン）
- ✅ NPCの初期メッセージ表示
- ✅ メトリクス表示（怒りメーター、信頼度、商談進捗度）
- ✅ ゴールパネル表示
- ✅ メッセージ入力欄表示
- ✅ 感情状態表示（絵文字フィードバック）

#### Phase 4: 音声設定
- ✅ 音声出力ON/OFFスイッチ
- ✅ 音量スライダー（80%表示）
- ✅ 読み上げ速度調整
- ✅ 無音検出時間設定

#### Phase 5: セッション終了
- ✅ 「商談終了」ボタンクリック
- ✅ 終了メッセージ表示（「商談が終了しました。結果画面に移動します...」）
- ✅ 録画データのS3アップロード成功
- ✅ 結果画面への自動遷移

#### Phase 6: 結果画面
- ✅ 分析中表示（ポーリング）
- ✅ 評価サマリータブ
  - 総合スコア表示
  - パフォーマンスレベル表示
  - レーダーチャート表示
  - キーポイント分析表示
  - 詳細評価（メトリクス）表示
  - スキル詳細スコア表示
  - ゴール達成状況表示
- ✅ 対話履歴タブ
- ✅ コンプライアンスタブ
- ✅ 表情・身振り分析タブ（動画分析結果: 7/10）
- ✅ リファレンスチェックタブ
- ✅ 「別のシナリオに挑戦」ボタン → シナリオ一覧へ遷移
- ✅ 「ホームに戻る」ボタン → ホーム画面へ遷移

#### Phase 8: アクセシビリティ
- ✅ Tabキーによるフォーカス移動
- ✅ Enterキーによるボタン実行
- ✅ ARIA属性の存在確認（tablist, tab, tabpanel, progressbar等）

### 発見された問題点

なし（全テスト項目がPASS）

### 備考

- 本計画は「シナリオの実施」機能に限定しています
- シナリオ作成・編集・削除機能は別スコープとします
- 音声分析機能（AudioAnalysisPage）は別スコープとします
- 音声認識（マイク入力）テストは別スコープとします
- 動画録画機能テストは別スコープとします
- 多言語テスト（英語）は別スコープとします
