# 3Dアバター機能 Phase 3（拡張実装） - 要件定義書

## 1. 概要

### 1.1 Intent Analysis（意図分析）

| 項目 | 内容 |
|------|------|
| **ユーザーリクエスト** | Phase 2（標準実装）で実装した3Dアバター機能を拡張レベルに強化 |
| **リクエストタイプ** | 機能強化（Enhancement） |
| **スコープ** | 複数コンポーネント（フロントエンド + バックエンド + インフラ） |
| **複雑度** | 高（AI連動ジェスチャー、VRMアップロード、S3/DynamoDB統合） |
| **前提条件** | Phase 2完了済み（Visemeリップシンク、AI感情分析、複数アバター対応） |

### 1.2 Phase 2からの差分

Phase 2（標準実装）で実装済み：
- Amazon Polly Visemeによる母音リップシンク
- AI感情分析（realtime-scoring）による表情自動連動
- 複数アバター切り替え対応（manifest.json管理）
- ExpressionControllerによるスムーズな感情トランジション
- AnimationControllerによる瞬き・呼吸アニメーション

Phase 3で追加する機能：
- AI駆動ジェスチャーアニメーション（うなずき・首かしげ）
- 感情トランジションの高度化
- アイドルモーションの多様化（視線移動、体の揺れ、姿勢変化）
- VRMファイルアップロード機能（S3 + DynamoDB管理）
- レスポンシブレイアウト対応

---

## 2. 機能要件

### 2.1 AI駆動ジェスチャーアニメーション

| ID | 要件 | 優先度 |
|----|------|--------|
| P3-FR-001 | リアルタイム評価APIのレスポンスに`gesture`フィールドを追加する | 必須 |
| P3-FR-002 | AI応答コンテキストに基づいてうなずき（nod）ジェスチャーをトリガーする | 必須 |
| P3-FR-003 | AI応答コンテキストに基づいて首かしげ（headTilt）ジェスチャーをトリガーする | 必須 |
| P3-FR-004 | ジェスチャーはプロシージャルアニメーションで実装する（VRMボーン操作） | 必須 |
| P3-FR-005 | ジェスチャーは既存の表情・リップシンクアニメーションと干渉しない | 必須 |

#### 技術仕様
- realtime-scoringエージェントの`ScoringResult`モデルに`gesture`フィールドを追加
  - 値: `"nod"`, `"headTilt"`, `"none"`（デフォルト: `"none"`）
- プロンプトにジェスチャー推定指示を追加
  - うなずき: NPCが同意・理解を示す場面
  - 首かしげ: NPCが疑問・考え中の場面
- AnimationControllerにジェスチャーメソッドを追加
  - `triggerNod()`: headボーンのX軸回転で実装
  - `triggerHeadTilt()`: headボーンのZ軸回転で実装
- ジェスチャーは一度トリガーされると自動的に元の位置に戻る（ワンショット）

### 2.2 感情トランジションの高度化

| ID | 要件 | 優先度 |
|----|------|--------|
| P3-FR-006 | 感情変化時に中間表情を経由するスムーズなトランジションを実装する | 必須 |
| P3-FR-007 | 感情強度に応じた微細な表情変化を実現する | 必須 |
| P3-FR-008 | 感情変化時にジェスチャーと連動した演出を行う（例: 怒り時に首を振る） | 推奨 |

#### 技術仕様
- ExpressionControllerのトランジションロジックを拡張
  - 感情間の中間状態を定義（例: neutral → happy は relaxed を経由）
  - 強度レベルに応じた表情の段階的変化
- トランジション速度を感情の種類に応じて調整
  - 急激な感情変化（怒り）: 高速トランジション
  - 穏やかな感情変化（リラックス）: 低速トランジション

### 2.3 アイドルモーションの多様化

| ID | 要件 | 優先度 |
|----|------|--------|
| P3-FR-009 | 待機中に視線がランダムに移動する（視線移動） | 必須 |
| P3-FR-010 | 待機中に体が微細に揺れる（体の揺れ） | 必須 |
| P3-FR-011 | 待機中に姿勢が緩やかに変化する（姿勢シフト） | 推奨 |
| P3-FR-012 | アイドルモーションは発話中・ジェスチャー中は抑制される | 必須 |

#### 技術仕様
- AnimationControllerに以下のアイドルモーションを追加（プロシージャル生成）
  - 視線移動: `leftEye`/`rightEye`ボーンまたはVRM lookAtで実装
    - ランダムな方向に3-8秒間隔で視線を移動
    - 移動範囲: 水平±15度、垂直±10度
  - 体の揺れ: `spine`ボーンの微細な回転
    - 周期: 5-10秒のサイン波
    - 振幅: ±0.5度程度
  - 姿勢シフト: `spine`/`chest`ボーンの緩やかな変化
    - 30-60秒間隔で姿勢を微調整
- 発話中・ジェスチャー中はアイドルモーションの振幅を50%に抑制

### 2.4 VRMファイルアップロード機能

| ID | 要件 | 優先度 |
|----|------|--------|
| P3-FR-013 | 管理者がVRMファイルをアップロードしてアバターを追加できる | 必須 |
| P3-FR-014 | アップロードされたVRMファイルはS3に保存される | 必須 |
| P3-FR-015 | アバターメタデータ（名前、説明、S3キー等）はDynamoDBに保存される | 必須 |
| P3-FR-016 | アップロード済みアバターの一覧を取得できるAPIを提供する | 必須 |
| P3-FR-017 | アバターの削除機能を提供する（S3 + DynamoDB両方から削除） | 必須 |
| P3-FR-018 | VRMファイルはCloudFront経由で配信される | 必須 |
| P3-FR-019 | アバターサムネイル画像の自動生成または手動アップロードに対応する | 推奨 |
| P3-FR-020 | 既存のmanifest.jsonベースのアバターとの後方互換性を維持する | 必須 |

#### 技術仕様
- S3バケット: 既存のアセット用バケットまたは新規アバター専用バケット
- DynamoDBテーブル: アバターメタデータ管理
  - PK: `avatarId`
  - 属性: `name`, `description`, `s3Key`, `thumbnailS3Key`, `createdAt`, `updatedAt`, `createdBy`
- API:
  - `POST /avatars/upload-url` - 署名付きURL取得
  - `POST /avatars` - メタデータ登録
  - `GET /avatars` - アバター一覧取得
  - `DELETE /avatars/{avatarId}` - アバター削除
- CloudFront: S3オリジンからVRMファイルを配信
- ファイルサイズ制限: 50MB以下
- 対応形式: `.vrm`のみ

### 2.5 レスポンシブレイアウト対応

| ID | 要件 | 優先度 |
|----|------|--------|
| P3-FR-021 | 3Dアバター表示サイズがビューポートに応じて自動調整される | 必須 |
| P3-FR-022 | タブレット（768px以上）でアバターが適切に表示される | 必須 |
| P3-FR-023 | モバイル（768px未満）でアバターが縮小表示される | 推奨 |
| P3-FR-024 | WebGLコンテキストのリサイズに対応する | 必須 |

#### 技術仕様
- VRMAvatarContainerのサイズをCSSレスポンシブで制御
- Three.jsレンダラーのリサイズハンドラーを実装
- ブレークポイント:
  - デスクトップ（1024px以上）: フルサイズ表示
  - タブレット（768px-1023px）: 80%サイズ
  - モバイル（768px未満）: 60%サイズ、レイアウト調整

---

## 3. 非機能要件

| ID | 要件 | 基準 |
|----|------|------|
| P3-NFR-001 | ジェスチャーアニメーションのトリガーから表示までのレイテンシーは100ms以内 | 目標 |
| P3-NFR-002 | アイドルモーションによるCPU使用率の増加は5%以内 | 目標 |
| P3-NFR-003 | VRMファイルアップロードは50MB以下のファイルに対応する | 必須 |
| P3-NFR-004 | アバター一覧APIのレスポンスは500ms以内 | 目標 |
| P3-NFR-005 | S3からのVRMファイル配信はCloudFrontキャッシュを活用する | 必須 |
| P3-NFR-006 | レスポンシブ対応でフレームレートが30fps以上を維持する | 目標 |
| P3-NFR-007 | Chrome最新版での動作確認（Phase 1/2と同様） | 必須 |

---

## 4. 変更影響範囲

### 4.1 バックエンド変更（新規）
| ファイル | 変更内容 |
|----------|----------|
| `cdk/agents/realtime-scoring/models.py` | `gesture`フィールド追加 |
| `cdk/agents/realtime-scoring/prompts.py` | ジェスチャー推定プロンプト追加 |
| `cdk/lambda/avatars/` (新規) | アバターCRUD Lambda関数群 |
| `cdk/lib/constructs/storage/` | アバター用S3バケット、DynamoDBテーブル |
| `cdk/lib/constructs/api/` | アバターAPI Gateway エンドポイント |

### 4.2 フロントエンド変更（既存拡張）
| ファイル | 変更内容 |
|----------|----------|
| `frontend/src/components/avatar/AnimationController.ts` | ジェスチャー、アイドルモーション追加 |
| `frontend/src/components/avatar/ExpressionController.ts` | トランジション高度化 |
| `frontend/src/components/avatar/VRMAvatarContainer.tsx` | gestureプロパティ追加、レスポンシブ対応 |
| `frontend/src/components/avatar/VRMAvatar.tsx` | リサイズハンドラー追加 |
| `frontend/src/pages/ConversationPage.tsx` | gestureデータの受け渡し |

### 4.3 フロントエンド変更（新規）
| ファイル | 変更内容 |
|----------|----------|
| `frontend/src/services/AvatarService.ts` (新規/拡張) | アバターアップロード・管理API呼び出し |
| `frontend/src/components/avatar/AvatarUpload.tsx` (新規) | VRMアップロードUI |
| `frontend/src/components/avatar/AvatarManagement.tsx` (新規) | アバター管理画面 |

### 4.4 変更不要
- 認証・セキュリティ（既存Cognito認証をそのまま使用）
- リップシンク（Phase 2のViseme実装をそのまま使用）
- 音声認識・録画・評価機能（既存機能に影響なし）

---

## 5. 実装優先度

質問Q6の回答に基づき、3つの機能を同等優先度で実装する：

| 優先度 | 機能 | 理由 |
|--------|------|------|
| 1 | ジェスチャー + アイドルモーション + 感情高度化 (2.1-2.3) | 没入感向上、フロントエンドのみの変更で完結しやすい |
| 2 | VRMアップロード機能 (2.4) | 運用性向上、バックエンド+インフラ変更が必要 |
| 3 | レスポンシブ対応 (2.5) | アクセシビリティ向上、CSS中心の変更 |

---

## 6. 成功基準

1. NPCの応答に応じてうなずき・首かしげジェスチャーが自然に発生する
2. 待機中にアバターが視線移動・体の揺れ等の自然なアイドルモーションを行う
3. 感情変化がスムーズで段階的なトランジションで表現される
4. 管理者がVRMファイルをアップロードしてアバターを追加・管理できる
5. 3Dアバターがタブレット・モバイルでも適切に表示される
6. 既存機能（音声認識、録画、評価、コンプライアンスチェック）が正常に動作する
