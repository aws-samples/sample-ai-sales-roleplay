# 3Dアバター機能 - 要件定義書

## 1. 概要

### 1.1 Intent Analysis（意図分析）

| 項目 | 内容 |
|------|------|
| **ユーザーリクエスト** | 現在の簡易的なアイコンと絵文字表現を3Dアバターに置き換え、リアルな会話体験を実現 |
| **リクエストタイプ** | 機能強化（Enhancement） |
| **スコープ** | 複数コンポーネント（フロントエンド中心、音声連携含む） |
| **複雑度** | 中〜高（Three.js/VRM統合、リップシンク、表情制御） |
| **参考資料** | https://zenn.dev/t_ponta/articles/f131defa22ce1f |

### 1.2 プロジェクト背景

現在のAI営業ロールプレイアプリケーションでは、NPCの表現が絵文字（EmojiFeedback）とシンプルなアバターアイコン（NPCInfoCard）に限定されており、ユーザーから「チープ」「人間味がない」というフィードバックがある。3Dアバターを導入することで、より没入感のある営業トレーニング体験を提供する。

---

## 2. 機能要件

### 2.1 アバターモデル管理

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-001 | VRoid Studioで作成したVRM形式の3Dアバターを表示できる | 必須 |
| FR-002 | 複数のアバターモデルを事前にデプロイし、管理できる | 必須 |
| FR-003 | シナリオ作成時に使用するアバターを選択できる | 必須 |
| FR-004 | シナリオごとに異なるアバターを設定できる | 必須 |

### 2.2 アバター表示

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-005 | 会話画面でアバターを顔のアップ（表情重視）で表示する | 必須 |
| FR-006 | 現在の絵文字フィードバック（EmojiFeedback）を3Dアバターで完全に置き換える | 必須 |
| FR-007 | Three.jsとpixiv/three-vrmライブラリを使用してVRMモデルをレンダリングする | 必須 |

### 2.3 表情・感情表現

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-008 | NPCの発言内容をAIで分析し、感情を推定して表情に反映する | 必須 |
| FR-009 | VRM標準の表情プリセット（happy, angry, sad, relaxed, neutral）を使用する | 必須 |
| FR-010 | 表情の変化はスムーズにトランジションする | 推奨 |

### 2.4 リップシンク

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-011 | Amazon Pollyの音声出力と同期して口を動かす | 必須 |
| FR-012 | 母音認識による口形状の変化（あ・い・う・え・お）を実装する | 必須 |
| FR-013 | Amazon Polly Speech Marks API（viseme）を使用して口形状データを取得する | 必須 |
| FR-014 | VRMの口形状（aa, ih, ou, ee, oh）にマッピングする | 必須 |

### 2.5 アニメーション

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-015 | 待機中に瞬きアニメーションを実行する（ランダム間隔） | 必須 |
| FR-016 | 微細な体の揺れ（呼吸のような動き）を実装する | 必須 |
| FR-017 | アニメーションはコードベース（プロシージャル）で実装する | 必須 |

### 2.6 シナリオ管理統合

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-018 | シナリオ作成画面にアバター選択UIを追加する | 必須 |
| FR-019 | シナリオデータにアバターIDを保存する | 必須 |
| FR-020 | 会話開始時にシナリオに紐づくアバターを読み込む | 必須 |
| FR-021 | デフォルトアバターを設定できる | 必須 |
| FR-022 | シナリオにアバターIDが未定義の場合、デフォルトアバターを使用する | 必須 |

---

## 3. 非機能要件

### 3.1 パフォーマンス

| ID | 要件 | 基準 |
|----|------|------|
| NFR-001 | デスクトップブラウザ（Chrome, Firefox, Edge, Safari）で動作する | 必須 |
| NFR-002 | 60fpsでスムーズにレンダリングする | 目標 |
| NFR-003 | VRMモデルの読み込み時間は3秒以内 | 目標 |
| NFR-004 | メモリ使用量は追加で200MB以内 | 目標 |

### 3.2 互換性

| ID | 要件 | 基準 |
|----|------|------|
| NFR-005 | WebGL 2.0対応ブラウザで動作する | 必須 |
| NFR-006 | 既存の音声認識・合成機能と共存する | 必須 |
| NFR-007 | 既存のセッション録画機能と共存する | 必須 |

### 3.3 アクセシビリティ

| ID | 要件 | 基準 |
|----|------|------|
| NFR-008 | 3Dアバターが表示できない環境向けのフォールバックを提供する | 推奨 |
| NFR-009 | アニメーションは`prefers-reduced-motion`設定を尊重する | 必須 |

### 3.4 保守性

| ID | 要件 | 基準 |
|----|------|------|
| NFR-011 | アバターコンポーネントは独立したモジュールとして実装する | 必須 |
| NFR-012 | 新しいアバターモデルの追加が容易な設計にする | 必須 |
| NFR-013 | 表情・アニメーションのパラメータは設定ファイルで管理する | 推奨 |

---

## 4. 技術仕様

### 4.1 使用ライブラリ

| ライブラリ | バージョン | 用途 |
|-----------|-----------|------|
| three | ^0.182.0 | 3Dレンダリングエンジン |
| @pixiv/three-vrm | ^3.4.5 | VRMモデルローダー・制御 |

### 4.2 アーキテクチャ

```
frontend/
├── src/
│   ├── components/
│   │   └── avatar/
│   │       ├── VRMAvatar.tsx          # メインアバターコンポーネント
│   │       ├── VRMLoader.ts           # VRMモデルローダー
│   │       ├── ExpressionController.ts # 表情制御
│   │       ├── LipSyncController.ts   # リップシンク制御
│   │       └── AnimationController.ts # アニメーション制御
│   ├── services/
│   │   └── AvatarService.ts           # アバター管理サービス
│   └── types/
│       └── avatar.ts                  # アバター関連型定義
├── public/
│   └── models/
│       └── avatars/                   # VRMモデルファイル
```

### 4.3 データモデル

```typescript
// シナリオにアバターIDを追加
interface Scenario {
  // 既存フィールド...
  avatarId?: string;  // 使用するアバターのID（未定義の場合はデフォルト使用）
}

// アバター情報
interface AvatarInfo {
  id: string;
  name: string;
  modelPath: string;  // VRMファイルのパス
  thumbnail?: string; // サムネイル画像
  description?: string;
  isDefault?: boolean; // デフォルトアバターフラグ
}
```

### 4.4 感情分析連携

NPCの発言内容から感情を推定するため、既存のBedrock APIを拡張：

```typescript
interface NPCResponseWithEmotion {
  response: string;
  emotion: 'happy' | 'angry' | 'sad' | 'relaxed' | 'neutral';
  emotionIntensity: number; // 0.0 - 1.0
}
```

---

## 5. 実装フェーズ

### Phase 1: MVP（最小限の実装）
- VRMモデルの表示
- 基本的なリップシンク（音量ベース）
- 瞬きアニメーション
- 単一アバターでの動作確認

### Phase 2: 標準実装
- Amazon Polly Visemeによる母音リップシンク
- AI感情分析による表情連動
- 複数アバター対応
- シナリオ管理統合

### Phase 3: 拡張実装（将来）
- より豊かなアニメーション
- アバターカスタマイズ機能
- モバイル対応

---

## 6. 制約事項

1. **VRMモデルの準備**: VRoid Studioで作成したモデルを事前にデプロイする必要がある
2. **ブラウザ対応**: WebGL 2.0非対応ブラウザでは動作しない
3. **Polly Viseme**: Generativeエンジンではvisemeが使用できないため、Standard/Neuralボイスを使用
4. **モバイル非対応**: 初期実装ではデスクトップブラウザのみ対応

---

## 7. 成功基準

1. 3Dアバターが会話画面に表示され、NPCの発言に合わせて口が動く
2. NPCの感情に応じて表情が変化する
3. シナリオごとに異なるアバターを設定できる
4. 既存機能（音声認識、録画、評価）が正常に動作する
5. ユーザーから「リアル」「没入感がある」というフィードバックを得られる

