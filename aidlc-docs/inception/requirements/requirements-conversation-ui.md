# 会話画面UI/UXリデザイン - 要件定義書

## インテント分析

- **ユーザーリクエスト**: 3Dアバターとの会話体験に合わせて、会話画面のUI/UXをアバター中心のデザインに刷新する
- **リクエストタイプ**: Enhancement（既存機能の大幅改善）
- **スコープ**: 会話画面（page-conversation）のみ。他の画面（ホーム、シナリオ選択、結果、履歴、ランキング、プロフィール）はスコープ外
- **複雑度**: Moderate（UIレイアウトの大幅変更だが、バックエンドAPIの変更は不要）
- **モック検証**: `aidlc-docs/inception/application-design/mock-v2/` で全デザインを検証済み

## 機能要件

### FR-1: 会話画面レイアウトの刷新

#### FR-1.1: アバターステージ（中央メインエリア）
- アバター（VRM 3Dモデル）を画面中央に大きく表示する
- アバターの上にNPC名を表示する（半透明背景のラベル）
- アバターの感情表現（happy, satisfied, neutral, annoyed, angry）をメトリクスに連動させる
- 発話中アニメーション（口の動き + サウンドウェーブインジケーター）を表示する
- アバターステージは `flex: 1` で残りスペースを占有する

#### FR-1.2: チャットログ（下部コンパクト表示）
- チャットログを画面下部に配置する（`position: relative`、`max-height: 150px`）
- クリック/タップで展開可能にする（展開時はアバターエリアが縮小）
- NPC発言とユーザー発言を左右に分けて表示する
- 各メッセージにアバターアイコン（小）を付与する
- 新しいメッセージ追加時に自動スクロールする
- NPC発言は吹き出し廃止 → チャットログに一本化する

#### FR-1.3: 入力エリア（下部固定）
- マイクボタン（音声入力トグル）、テキスト入力フィールド、送信ボタを横並びで配置する
- マイクアクティブ時は赤色パルスアニメーションを表示する
- 入力ヒント領域（音声認識ステータス等）を表示する

### FR-2: メトリクスオーバーレイ（左上）

- 怒り・信頼・進捗の3メトリクスをプログレスバーで表示する
- 半透明白背景 + backdrop-filter: blur のオーバーレイスタイル
- 各メトリクスにカラーコード付きテキストラベル（怒り=赤、信頼=青、進捗=緑）を使用する
- 📊ボタンで表示/非表示をトグルできる
- デフォルト: 表示ON

### FR-3: ゴールパネル（右側オーバーレイ）

- ゴール一覧をチェックボックス + プログレスバーで表示する
- 各ゴールに達成率（%）を表示する
- 達成済みゴールは緑色 + ✅アイコンで表示する
- デフォルト: 表示ON
- メトリクスオーバーレイと同じ半透明スタイル
- 右側パネル一括トグルで表示/非表示を制御する

### FR-4: シナリオパネル（右側オーバーレイ、ゴール下）

- シナリオの説明文を表示する
- ゴールパネルと同じ半透明オーバーレイスタイル
- デフォルト: 表示ON
- ゴールパネルの下に縦並びで配置する
- 右側パネル一括トグルで表示/非表示を制御する

### FR-5: ペルソナパネル（右側オーバーレイ、シナリオ下）

- NPC名、役職、アバターアイコンをヘッダーに表示する
- NPCのペルソナ説明文を全文表示する（切り詰めなし）
- デフォルト: 表示ON
- シナリオパネルの下に縦並びで配置する
- ゴール・シナリオ・ペルソナは同一の右側コンテナ内で縦スクロール可能
- 右側パネル一括トグルで表示/非表示を制御する

### FR-6: コーチングヒントバー（入力エリア上部）

- リアルタイム評価APIの `analysis` フィールドをコーチングヒントとして表示する
- 💡アイコン + テキストのコンパクトなバー形式
- アクセントカラー背景で目立たせる
- フェードインアニメーションで表示する
- ヒントがない場合は非表示（`hidden`）

### FR-7: コンプライアンスアラート（ヘッダー下スライドイン）

- リアルタイム評価APIの `compliance` フィールドの違反をアラート表示する
- 重大度に応じた色分け（high=赤、medium=黄、low=青）
- 重大度ラベル + メッセージ + 閉じるボタン
- スライドダウンアニメーションで表示する
- 8秒後に自動非表示、または手動で閉じる

### FR-8: 会話ヘッダー

- 戻るボタン（←）でセッション終了確認モーダルを表示する
- シナリオタイトル + 難易度バッジを表示する
- 「セッション終了」ボタンを常にヘッダーに表示する（終了確認モーダルを経由）
- ヘッダー右側にアクションボタン群を配置する:
  - 📋 右側パネル一括トグル（ゴール+シナリオ+ペルソナ）
  - 📊 メトリクスパネルトグル
  - 🔊 音声設定モーダル

### FR-9: リアルタイムAPI応答のUI統合

- `scores`（angerLevel, trustLevel, progressLevel）→ メトリクスオーバーレイに反映
- `analysis` → コーチングヒントバーに表示
- `goalStatuses` → ゴールパネルのプログレスバーに反映
- `compliance` → コンプライアンスアラートバナーに表示
- NPC応答テキスト → チャットログに追加 + アバター発話アニメーション

### FR-10: 既存コンポーネントの削除

- EmojiFeedbackContainer を完全に削除する（アバターの表情で代替）
- 関連するインポート・参照もすべて削除する

### FR-11: 録画機能（VideoRecorder）の配置

- VideoRecorderコンポーネントをアバターステージの隅に小さく配置する
- 録画中インジケーターを視覚的に表示する
- アバター表示を妨げないサイズ・位置にする

## 非機能要件

### NFR-1: パフォーマンス
- メトリクス更新のアニメーションは CSS transition（0.5s ease）で滑らかに行う
- チャットメッセージ追加時のアニメーションは 0.3s 以内に完了する
- 不要な再レンダリングを防ぐため、useMemo/useCallback を適切に使用する

### NFR-2: アクセシビリティ
- メトリクスバーに `role="progressbar"` と `aria-valuenow/min/max/label` を設定する
- ゴールリストに `role="list"` / `role="listitem"` を設定する
- 感情状態の変化をスクリーンリーダーに通知する（`aria-live="polite"`）
- ゴール達成時にスクリーンリーダーに通知する
- コンプライアンスアラートに `role="alert"` を設定する
- すべてのボタンに `aria-label` を設定する
- `prefers-reduced-motion` メディアクエリでアニメーションを無効化する

### NFR-3: レスポンシブ対応
- モバイル画面（640px以下）でも操作可能なレイアウトにする
- オーバーレイパネルの最大幅を制限する（260-280px）

### NFR-4: 国際化
- すべてのUIテキスト（ラベル、ボタン、ヒント等）をi18nキーで管理する
- 日本語・英語の両言語に対応する

### NFR-5: テーマ対応
- Material UIのテーマシステムと整合するカラートークンを使用する
- 半透明オーバーレイは `rgba(255, 255, 255, 0.92)` + `backdrop-filter: blur(8px)` を基本とする

## 技術的制約

- フロントエンドのみの変更（バックエンドAPI変更なし）
- 既存のReact Context API（状態管理）を活用する
- 既存のAPIサービス層（`frontend/src/services/`）をそのまま使用する
- 既存の3Dアバターコンポーネント（VRM/three.js）と統合する
- Material UI 7.x のコンポーネントを活用する

## デザインリファレンス

- モックHTML/CSS/JS: `aidlc-docs/inception/application-design/mock-v2/`
  - `index.html` - 画面構造
  - `styles.css` - スタイル定義
  - `app.js` - インタラクション・状態管理ロジック
